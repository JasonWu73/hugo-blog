---
toc: true
categories:
  - JavaScript
tags:
  - Async
title: ğŸ“Œ JavaScript å¼‚æ­¥åŸç†ï¼šEvent Loop
weight: 1
date: 2021-05-30
description: è¯¦è§£ JS å¼‚æ­¥æœºåˆ¶çš„å®ç°åŸç†
---

![](/img/js-async-runtime.jpg)

<!--more-->

## åŸç†

å›è°ƒé˜Ÿåˆ— vs å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼šå¾®ä»»åŠ¡é˜Ÿåˆ—å’Œå›è°ƒé˜Ÿåˆ—å”¯ä¸€çš„ä¸åŒç‚¹åœ¨äºæ‰§è¡Œä¼˜å…ˆçº§ï¼Œå…¶ä¸­å¾®ä»»åŠ¡é˜Ÿåˆ—æ‹¥æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œæ•…å›è°ƒé˜Ÿåˆ—å¯èƒ½ä¼šå‡ºç° starveã€‚

> å› ä¸ºå¾®ä»»åŠ¡é˜Ÿåˆ—å’Œå›è°ƒé˜Ÿåˆ—çš„ä»£ç éƒ½æ˜¯æ¥è‡ªäºå›è°ƒå‡½æ•°ï¼Œæ•…ä¸‹æ–‡åœ¨éå¿…è¦æƒ…å†µä¸‹ï¼Œå…¨éƒ¨ä»¥å›è°ƒé˜Ÿåˆ—ä½œä¸ºè®²è§£ã€‚

Event Loop
: è´Ÿè´£åè°ƒé™¤ç¨‹åºå¼€å§‹è¿è¡Œæ—¶ï¼Œå³å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆGlobal Execution Contextï¼‰ä»¥å¤–çš„æ•´ä¸ª JS æ‰§è¡Œè¿‡ç¨‹ï¼Œå¹¶å†³å®šæ¯ä¸ªå›è°ƒåº”è¯¥åœ¨ä½•æ—¶è¢«æ‰§è¡Œã€‚

Event Loop Tick
: å½“ Call Stack ä¸ºç©ºï¼ŒEvent Loop å°†å›è°ƒé˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå›è°ƒæ”¾å…¥ Call Stack æ‰§è¡Œã€‚

å›è°ƒé˜Ÿåˆ—ï¼šå›è°ƒé˜Ÿåˆ—ä¸­çš„å›è°ƒå‡½æ•°æ—¢å¯ä»¥æ¥è‡ªå¼‚æ­¥ä»£ç ï¼Œä¹Ÿå¯ä»¥æ¥è‡ªåŒæ­¥ä»£ç ï¼ˆæ¯”å¦‚ DOM äº‹ä»¶ï¼š`click`ã€`keydown` ç­‰ï¼‰ã€‚

JS å¼•æ“å¯¹æ—¶é—´æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œå› ä¸ºå¼‚æ­¥æ ¹æœ¬ä¸å‘ç”Ÿåœ¨ JS å¼•æ“ä¸­ï¼Œä»€ä¹ˆæ—¶é—´æ‰§è¡Œä»€ä¹ˆä»£ç å…¨éƒ¨éƒ½ç”± Event Loop å†³å®šï¼ŒJS å¼•æ“ï¼ˆå•çº¿ç¨‹ï¼‰åªè´Ÿè´£æ‰§è¡Œ Event Loop äº¤ç»™å®ƒçš„ä»£ç è€Œå·²ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œæµè§ˆå™¨çš„ Web API ç¯å¢ƒã€å›è°ƒé˜Ÿåˆ—ä»¥åŠ Event Loop è¿™äº›ä¸€èµ·æ‰å®ç°äº†å•çº¿ç¨‹ JS å¼•æ“çš„éé˜»å¡æœºåˆ¶ã€‚

## ç¤ºä¾‹ï¼šDOM åŠ è½½å›¾ç‰‡

```js
const img = document.querySelector('.logo');

// DOM åŠ è½½å›¾ç‰‡æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œ
img.src = 'logo.png';

img.addEventListener('load', () => {
  // åœ¨å›¾ç‰‡åŠ è½½å®Œæˆåè§¦å‘
  p.textContent = 'å›¾ç‰‡åŠ è½½å®Œæˆ';
});
```

ä»¥ä¸Šä»£ç åœ¨æµè§ˆå™¨è¿è¡Œç¯å¢ƒä¸‹çš„æ‰§è¡Œè¿‡ç¨‹ï¼š

1. ç¨‹åºå¼€å§‹è¿è¡Œæ—¶ï¼ŒCall Stack ä¸­åŠ å…¥å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡
2. åœ¨ Call Stack é¡¶éƒ¨åŠ å…¥æ‰§è¡Œä¸Šä¸‹æ–‡ `querySelector()`ï¼Œç»“æŸå¹¶ç§»é™¤
3. åœ¨ Call Stack é¡¶éƒ¨åŠ å…¥æ‰§è¡Œä¸Šä¸‹æ–‡ `img.src`ï¼ˆå°†åŠ è½½å›¾ç‰‡çš„è¡Œä¸ºäº¤ç»™ Web APIï¼‰ï¼Œç»“æŸå¹¶ç§»é™¤
4. åœ¨ Call Stack é¡¶éƒ¨åŠ å…¥æ‰§è¡Œä¸Šä¸‹æ–‡ `addEventListener()`ï¼ˆå°†å›è°ƒå‡½æ•°æ³¨å†Œåˆ° Web APIï¼‰ï¼Œç»“æŸå¹¶ç§»é™¤
5. å›¾ç‰‡åŠ è½½å®Œæˆï¼Œæµè§ˆå™¨ Web API å°†å›è°ƒæ”¾å…¥å›è°ƒé˜Ÿåˆ—çš„å°¾éƒ¨
6. Event Loop å‘ç° Call Stack ä¸ºç©ºï¼Œæ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ä¹Ÿä¸ºç©ºï¼Œç„¶åä»å›è°ƒé˜Ÿåˆ—ä¸­å–ç¬¬ä¸€ä¸ªå›è°ƒæ”¾å…¥ Call Stack
7. JS å¼•æ“æ‰§è¡Œå›è°ƒ

## ä»£ç æ±‚è¯

éœ€è¯æ˜ä»¥ä¸‹å‡ ä¸ªç»“è®ºï¼š

- `setTimeout` æ˜¯å¼‚æ­¥è¡Œä¸ºï¼Œå…¶å›è°ƒå‡½æ•°æ˜¯è¢«æ”¾å…¥å›è°ƒé˜Ÿåˆ—
- Promise æ˜¯å¼‚æ­¥è¡Œä¸ºï¼Œå…¶å›è°ƒå‡½æ•°æ˜¯è¢«æ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
- å¾®ä»»åŠ¡é˜Ÿåˆ—çš„ä¼˜å…ˆçº§è¦é«˜äºå›è°ƒé˜Ÿåˆ—

```js
// å…ˆæ³¨å†Œå›è°ƒé˜Ÿåˆ—
setTimeout(() => console.log('0ç§’å®šæ—¶å™¨'), 0);

// å†æ³¨å†Œå¾®ä»»åŠ¡é˜Ÿåˆ—
Promise.resolve('3ç§’ Promise').then(msg => {
  // å‡è®¾åœ¨ Call Stack ä¸­è¿è¡Œä¸€æ®µè€—æ—¶ä»£ç 
  const start = Date.now();

  while (Date.now() - start <= 3000) {
    // æ¨¡æ‹Ÿ3ç§’è€—æ—¶æ“ä½œ
  }

  console.log(msg);
});

console.log('1ï¼šå¼€å§‹æ‰§è¡Œè€—æ—¶åŒæ­¥ä»£ç ')

// å‡è®¾åœ¨ Call Stack ä¸­æ­£åœ¨è¿è¡Œä¸€æ®µè€—æ—¶ä»£ç 
const start = Date.now();

while (Date.now() - start <= 1000) {
  // æ¨¡æ‹Ÿ1ç§’è€—æ—¶æ“ä½œ
}

console.log('2ï¼šç»“æŸæ‰§è¡Œè€—æ—¶åŒæ­¥ä»£ç ')

// 1ï¼šå¼€å§‹æ‰§è¡Œè€—æ—¶åŒæ­¥ä»£ç 
// 2ï¼šç»“æŸæ‰§è¡Œè€—æ—¶åŒæ­¥ä»£ç 
// 3ç§’ Promise
// 0ç§’å®šæ—¶å™¨
```
